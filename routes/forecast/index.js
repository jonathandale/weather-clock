var mock = '{"latitude":30.4398,"longitude":-84.2806,"timezone":"America/New_York","offset":-5,"currently":{"time":1416713199,"summary":"Light Rain","icon":"rain","nearestStormDistance":0,"precipIntensity":0.028,"precipIntensityError":0.0067,"precipProbability":0.98,"precipType":"rain","temperature":61.77,"apparentTemperature":61.77,"dewPoint":59.94,"humidity":0.94,"windSpeed":7.42,"windBearing":72,"visibility":5.18,"cloudCover":1,"pressure":1019.96,"ozone":278.62},"minutely":{"summary":"Rain for the hour.","icon":"rain","data":[{"time":1416713160,"precipIntensity":0.0335,"precipIntensityError":0.0058,"precipProbability":1,"precipType":"rain"},{"time":1416713220,"precipIntensity":0.0251,"precipIntensityError":0.0071,"precipProbability":0.97,"precipType":"rain"},{"time":1416713280,"precipIntensity":0.0186,"precipIntensityError":0.0066,"precipProbability":0.96,"precipType":"rain"},{"time":1416713340,"precipIntensity":0.013,"precipIntensityError":0.0057,"precipProbability":0.92,"precipType":"rain"},{"time":1416713400,"precipIntensity":0.0104,"precipIntensityError":0.0049,"precipProbability":0.84,"precipType":"rain"},{"time":1416713460,"precipIntensity":0.0086,"precipIntensityError":0.0042,"precipProbability":0.7,"precipType":"rain"},{"time":1416713520,"precipIntensity":0.0085,"precipIntensityError":0.0037,"precipProbability":0.64,"precipType":"rain"},{"time":1416713580,"precipIntensity":0.0091,"precipIntensityError":0.0038,"precipProbability":0.68,"precipType":"rain"},{"time":1416713640,"precipIntensity":0.0103,"precipIntensityError":0.0043,"precipProbability":0.7,"precipType":"rain"},{"time":1416713700,"precipIntensity":0.0118,"precipIntensityError":0.0051,"precipProbability":0.74,"precipType":"rain"},{"time":1416713760,"precipIntensity":0.0138,"precipIntensityError":0.006,"precipProbability":0.78,"precipType":"rain"},{"time":1416713820,"precipIntensity":0.0163,"precipIntensityError":0.0068,"precipProbability":0.84,"precipType":"rain"},{"time":1416713880,"precipIntensity":0.0194,"precipIntensityError":0.0077,"precipProbability":0.88,"precipType":"rain"},{"time":1416713940,"precipIntensity":0.0232,"precipIntensityError":0.0086,"precipProbability":0.92,"precipType":"rain"},{"time":1416714000,"precipIntensity":0.0284,"precipIntensityError":0.0099,"precipProbability":0.94,"precipType":"rain"},{"time":1416714060,"precipIntensity":0.0355,"precipIntensityError":0.0114,"precipProbability":0.96,"precipType":"rain"},{"time":1416714120,"precipIntensity":0.0427,"precipIntensityError":0.0127,"precipProbability":0.98,"precipType":"rain"},{"time":1416714180,"precipIntensity":0.0509,"precipIntensityError":0.0142,"precipProbability":0.98,"precipType":"rain"},{"time":1416714240,"precipIntensity":0.0596,"precipIntensityError":0.0156,"precipProbability":0.99,"precipType":"rain"},{"time":1416714300,"precipIntensity":0.0675,"precipIntensityError":0.0165,"precipProbability":0.99,"precipType":"rain"},{"time":1416714360,"precipIntensity":0.0734,"precipIntensityError":0.0171,"precipProbability":1,"precipType":"rain"},{"time":1416714420,"precipIntensity":0.0765,"precipIntensityError":0.0171,"precipProbability":1,"precipType":"rain"},{"time":1416714480,"precipIntensity":0.0762,"precipIntensityError":0.0168,"precipProbability":1,"precipType":"rain"},{"time":1416714540,"precipIntensity":0.0733,"precipIntensityError":0.0163,"precipProbability":1,"precipType":"rain"},{"time":1416714600,"precipIntensity":0.0692,"precipIntensityError":0.0156,"precipProbability":1,"precipType":"rain"},{"time":1416714660,"precipIntensity":0.0651,"precipIntensityError":0.0149,"precipProbability":1,"precipType":"rain"},{"time":1416714720,"precipIntensity":0.0592,"precipIntensityError":0.0138,"precipProbability":1,"precipType":"rain"},{"time":1416714780,"precipIntensity":0.0539,"precipIntensityError":0.0129,"precipProbability":1,"precipType":"rain"},{"time":1416714840,"precipIntensity":0.0493,"precipIntensityError":0.012,"precipProbability":1,"precipType":"rain"},{"time":1416714900,"precipIntensity":0.0456,"precipIntensityError":0.0112,"precipProbability":1,"precipType":"rain"},{"time":1416714960,"precipIntensity":0.043,"precipIntensityError":0.0106,"precipProbability":1,"precipType":"rain"},{"time":1416715020,"precipIntensity":0.0408,"precipIntensityError":0.0102,"precipProbability":1,"precipType":"rain"},{"time":1416715080,"precipIntensity":0.0397,"precipIntensityError":0.0098,"precipProbability":1,"precipType":"rain"},{"time":1416715140,"precipIntensity":0.0382,"precipIntensityError":0.0094,"precipProbability":1,"precipType":"rain"},{"time":1416715200,"precipIntensity":0.0378,"precipIntensityError":0.0091,"precipProbability":1,"precipType":"rain"},{"time":1416715260,"precipIntensity":0.0381,"precipIntensityError":0.009,"precipProbability":1,"precipType":"rain"},{"time":1416715320,"precipIntensity":0.0374,"precipIntensityError":0.0089,"precipProbability":1,"precipType":"rain"},{"time":1416715380,"precipIntensity":0.0365,"precipIntensityError":0.0089,"precipProbability":1,"precipType":"rain"},{"time":1416715440,"precipIntensity":0.0354,"precipIntensityError":0.0089,"precipProbability":1,"precipType":"rain"},{"time":1416715500,"precipIntensity":0.0346,"precipIntensityError":0.0089,"precipProbability":1,"precipType":"rain"},{"time":1416715560,"precipIntensity":0.0341,"precipIntensityError":0.0089,"precipProbability":1,"precipType":"rain"},{"time":1416715620,"precipIntensity":0.0337,"precipIntensityError":0.0089,"precipProbability":1,"precipType":"rain"},{"time":1416715680,"precipIntensity":0.0335,"precipIntensityError":0.009,"precipProbability":1,"precipType":"rain"},{"time":1416715740,"precipIntensity":0.0327,"precipIntensityError":0.009,"precipProbability":1,"precipType":"rain"},{"time":1416715800,"precipIntensity":0.0322,"precipIntensityError":0.0089,"precipProbability":1,"precipType":"rain"},{"time":1416715860,"precipIntensity":0.0334,"precipIntensityError":0.0092,"precipProbability":0.99,"precipType":"rain"},{"time":1416715920,"precipIntensity":0.0326,"precipIntensityError":0.0092,"precipProbability":0.99,"precipType":"rain"},{"time":1416715980,"precipIntensity":0.0318,"precipIntensityError":0.0092,"precipProbability":0.99,"precipType":"rain"},{"time":1416716040,"precipIntensity":0.0311,"precipIntensityError":0.0092,"precipProbability":0.98,"precipType":"rain"},{"time":1416716100,"precipIntensity":0.0306,"precipIntensityError":0.0093,"precipProbability":0.98,"precipType":"rain"},{"time":1416716160,"precipIntensity":0.0302,"precipIntensityError":0.0093,"precipProbability":0.97,"precipType":"rain"},{"time":1416716220,"precipIntensity":0.0297,"precipIntensityError":0.0092,"precipProbability":0.96,"precipType":"rain"},{"time":1416716280,"precipIntensity":0.0293,"precipIntensityError":0.0093,"precipProbability":0.95,"precipType":"rain"},{"time":1416716340,"precipIntensity":0.0285,"precipIntensityError":0.0093,"precipProbability":0.94,"precipType":"rain"},{"time":1416716400,"precipIntensity":0.0278,"precipIntensityError":0.0093,"precipProbability":0.93,"precipType":"rain"},{"time":1416716460,"precipIntensity":0.0287,"precipIntensityError":0.0096,"precipProbability":0.92,"precipType":"rain"},{"time":1416716520,"precipIntensity":0.0277,"precipIntensityError":0.0096,"precipProbability":0.91,"precipType":"rain"},{"time":1416716580,"precipIntensity":0.0268,"precipIntensityError":0.0096,"precipProbability":0.89,"precipType":"rain"},{"time":1416716640,"precipIntensity":0.0264,"precipIntensityError":0.0096,"precipProbability":0.87,"precipType":"rain"},{"time":1416716700,"precipIntensity":0.0257,"precipIntensityError":0.0096,"precipProbability":0.86,"precipType":"rain"},{"time":1416716760,"precipIntensity":0.0252,"precipIntensityError":0.0095,"precipProbability":0.85,"precipType":"rain"}]},"hourly":{"summary":"Rain throughout the day.","icon":"rain","data":[{"time":1416711600,"summary":"Light Rain","icon":"rain","precipIntensity":0.0271,"precipProbability":1,"precipType":"rain","temperature":61.79,"apparentTemperature":61.79,"dewPoint":60.16,"humidity":0.94,"windSpeed":7.68,"windBearing":72,"visibility":5.24,"cloudCover":1,"pressure":1020.29,"ozone":278.91},{"time":1416715200,"summary":"Light Rain","icon":"rain","precipIntensity":0.0398,"precipProbability":1,"precipType":"rain","temperature":61.76,"apparentTemperature":61.76,"dewPoint":59.66,"humidity":0.93,"windSpeed":7.09,"windBearing":74,"visibility":5.1,"cloudCover":1,"pressure":1019.55,"ozone":278.26},{"time":1416718800,"summary":"Rain","icon":"rain","precipIntensity":0.1878,"precipProbability":1,"precipType":"rain","temperature":62.07,"apparentTemperature":62.07,"dewPoint":60.13,"humidity":0.93,"windSpeed":7.59,"windBearing":80,"visibility":4.19,"cloudCover":1,"pressure":1018.6,"ozone":277.74},{"time":1416722400,"summary":"Rain","icon":"rain","precipIntensity":0.1759,"precipProbability":1,"precipType":"rain","temperature":62.48,"apparentTemperature":62.48,"dewPoint":60.35,"humidity":0.93,"windSpeed":8.46,"windBearing":79,"visibility":4.68,"cloudCover":1,"pressure":1017.68,"ozone":277.56},{"time":1416726000,"summary":"Rain","icon":"rain","precipIntensity":0.1205,"precipProbability":0.69,"precipType":"rain","temperature":63.02,"apparentTemperature":63.02,"dewPoint":61.05,"humidity":0.93,"windSpeed":8.93,"windBearing":85,"visibility":5.79,"cloudCover":1,"pressure":1016.95,"ozone":277.84},{"time":1416729600,"summary":"Rain","icon":"rain","precipIntensity":0.0692,"precipProbability":0.53,"precipType":"rain","temperature":63.62,"apparentTemperature":63.62,"dewPoint":61.54,"humidity":0.93,"windSpeed":8.88,"windBearing":92,"visibility":6.43,"cloudCover":1,"pressure":1016.3,"ozone":278.46},{"time":1416733200,"summary":"Light Rain","icon":"rain","precipIntensity":0.0296,"precipProbability":0.52,"precipType":"rain","temperature":63.94,"apparentTemperature":63.94,"dewPoint":62.12,"humidity":0.94,"windSpeed":9.3,"windBearing":100,"visibility":6.85,"cloudCover":1,"pressure":1015.69,"ozone":279.25},{"time":1416736800,"summary":"Light Rain","icon":"rain","precipIntensity":0.027,"precipProbability":0.54,"precipType":"rain","temperature":64.4,"apparentTemperature":64.4,"dewPoint":62.72,"humidity":0.94,"windSpeed":9.22,"windBearing":104,"visibility":6.9,"cloudCover":1,"pressure":1015.08,"ozone":280.09},{"time":1416740400,"summary":"Light Rain","icon":"rain","precipIntensity":0.041,"precipProbability":0.67,"precipType":"rain","temperature":64.64,"apparentTemperature":64.64,"dewPoint":63.32,"humidity":0.95,"windSpeed":9.12,"windBearing":112,"visibility":6.73,"cloudCover":1,"pressure":1014.5,"ozone":281.11},{"time":1416744000,"summary":"Light Rain","icon":"rain","precipIntensity":0.051,"precipProbability":0.89,"precipType":"rain","temperature":65.51,"apparentTemperature":65.51,"dewPoint":63.91,"humidity":0.95,"windSpeed":9.75,"windBearing":120,"visibility":5.53,"cloudCover":1,"pressure":1014.06,"ozone":282.43},{"time":1416747600,"summary":"Light Rain","icon":"rain","precipIntensity":0.0443,"precipProbability":1,"precipType":"rain","temperature":66.46,"apparentTemperature":66.46,"dewPoint":65.04,"humidity":0.95,"windSpeed":11.35,"windBearing":129,"visibility":5.35,"cloudCover":1,"pressure":1013.86,"ozone":284.25},{"time":1416751200,"summary":"Light Rain","icon":"rain","precipIntensity":0.0296,"precipProbability":0.98,"precipType":"rain","temperature":67.62,"apparentTemperature":67.62,"dewPoint":66.41,"humidity":0.96,"windSpeed":12.57,"windBearing":139,"visibility":5.52,"cloudCover":1,"pressure":1013.77,"ozone":286.37},{"time":1416754800,"summary":"Light Rain","icon":"rain","precipIntensity":0.0166,"precipProbability":0.93,"precipType":"rain","temperature":68.8,"apparentTemperature":68.8,"dewPoint":67.36,"humidity":0.95,"windSpeed":13.57,"windBearing":146,"visibility":5.77,"cloudCover":1,"pressure":1013.48,"ozone":288.35},{"time":1416758400,"summary":"Light Rain","icon":"rain","precipIntensity":0.0171,"precipProbability":0.7,"precipType":"rain","temperature":70.08,"apparentTemperature":70.08,"dewPoint":68.49,"humidity":0.95,"windSpeed":14.63,"windBearing":152,"visibility":5.8,"cloudCover":1,"pressure":1012.83,"ozone":290.42},{"time":1416762000,"summary":"Light Rain","icon":"rain","precipIntensity":0.0186,"precipProbability":0.61,"precipType":"rain","temperature":71,"apparentTemperature":71,"dewPoint":69.24,"humidity":0.94,"windSpeed":15.34,"windBearing":158,"visibility":5.75,"cloudCover":1,"pressure":1012.05,"ozone":292.35},{"time":1416765600,"summary":"Light Rain","icon":"rain","precipIntensity":0.0211,"precipProbability":0.51,"precipType":"rain","temperature":71.88,"apparentTemperature":71.88,"dewPoint":70.05,"humidity":0.94,"windSpeed":15.89,"windBearing":162,"visibility":5.99,"cloudCover":1,"pressure":1011.37,"ozone":293.01},{"time":1416769200,"summary":"Light Rain","icon":"rain","precipIntensity":0.0389,"precipProbability":0.67,"precipType":"rain","temperature":71.99,"apparentTemperature":71.99,"dewPoint":69.81,"humidity":0.93,"windSpeed":16.22,"windBearing":164,"visibility":6.05,"cloudCover":0.99,"pressure":1010.8,"ozone":291.27},{"time":1416772800,"summary":"Rain","icon":"rain","precipIntensity":0.054,"precipProbability":0.81,"precipType":"rain","temperature":72.26,"apparentTemperature":72.26,"dewPoint":69.99,"humidity":0.93,"windSpeed":16.03,"windBearing":167,"visibility":8.38,"cloudCover":0.99,"pressure":1010.28,"ozone":288.25},{"time":1416776400,"summary":"Rain","icon":"rain","precipIntensity":0.0575,"precipProbability":0.84,"precipType":"rain","temperature":71.89,"apparentTemperature":71.89,"dewPoint":70.02,"humidity":0.94,"windSpeed":15.62,"windBearing":171,"visibility":8.51,"cloudCover":0.98,"pressure":1009.93,"ozone":286.17},{"time":1416780000,"summary":"Light Rain","icon":"rain","precipIntensity":0.0526,"precipProbability":0.77,"precipType":"rain","temperature":71.5,"apparentTemperature":71.5,"dewPoint":69.76,"humidity":0.94,"windSpeed":14.78,"windBearing":172,"visibility":8.73,"cloudCover":0.98,"pressure":1009.86,"ozone":286.05},{"time":1416783600,"summary":"Light Rain","icon":"rain","precipIntensity":0.0426,"precipProbability":0.69,"precipType":"rain","temperature":70.73,"apparentTemperature":70.73,"dewPoint":69.5,"humidity":0.96,"windSpeed":13.83,"windBearing":173,"visibility":8.98,"cloudCover":0.98,"pressure":1009.99,"ozone":286.87},{"time":1416787200,"summary":"Light Rain","icon":"rain","precipIntensity":0.0328,"precipProbability":0.63,"precipType":"rain","temperature":69.97,"apparentTemperature":69.97,"dewPoint":68.89,"humidity":0.96,"windSpeed":12.94,"windBearing":173,"visibility":6.72,"cloudCover":0.97,"pressure":1010.16,"ozone":287.73},{"time":1416790800,"summary":"Light Rain","icon":"rain","precipIntensity":0.0225,"precipProbability":0.46,"precipType":"rain","temperature":69.35,"apparentTemperature":69.35,"dewPoint":68.45,"humidity":0.97,"windSpeed":11.99,"windBearing":177,"visibility":5.92,"cloudCover":0.96,"pressure":1010.36,"ozone":288.64},{"time":1416794400,"summary":"Light Rain","icon":"rain","precipIntensity":0.0126,"precipProbability":0.23,"precipType":"rain","temperature":69.04,"apparentTemperature":69.04,"dewPoint":68.31,"humidity":0.98,"windSpeed":11.6,"windBearing":178,"visibility":5.98,"cloudCover":0.95,"pressure":1010.57,"ozone":289.6},{"time":1416798000,"summary":"Drizzle","icon":"rain","precipIntensity":0.0052,"precipProbability":0.05,"precipType":"rain","temperature":69.22,"apparentTemperature":69.22,"dewPoint":68.44,"humidity":0.97,"windSpeed":11.31,"windBearing":180,"visibility":7.57,"cloudCover":0.91,"pressure":1010.68,"ozone":289.79},{"time":1416801600,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.0018,"precipProbability":0.01,"precipType":"rain","temperature":69.29,"apparentTemperature":69.29,"dewPoint":68.55,"humidity":0.98,"windSpeed":11.16,"windBearing":180,"visibility":8.48,"cloudCover":0.88,"pressure":1010.58,"ozone":288.62},{"time":1416805200,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0,"precipProbability":0,"temperature":69.47,"apparentTemperature":69.47,"dewPoint":68.76,"humidity":0.98,"windSpeed":11.17,"windBearing":179,"visibility":9.14,"cloudCover":0.84,"pressure":1010.35,"ozone":286.67},{"time":1416808800,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0,"precipProbability":0,"temperature":69.5,"apparentTemperature":69.5,"dewPoint":68.83,"humidity":0.98,"windSpeed":11.17,"windBearing":179,"visibility":9.53,"cloudCover":0.81,"pressure":1010.17,"ozone":284.89},{"time":1416812400,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.0014,"precipProbability":0.01,"precipType":"rain","temperature":69.47,"apparentTemperature":69.47,"dewPoint":68.85,"humidity":0.98,"windSpeed":11.15,"windBearing":180,"visibility":9.76,"cloudCover":0.78,"pressure":1010.09,"ozone":283.59},{"time":1416816000,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.0023,"precipProbability":0.04,"precipType":"rain","temperature":69.46,"apparentTemperature":69.46,"dewPoint":68.88,"humidity":0.98,"windSpeed":11.38,"windBearing":181,"visibility":10,"cloudCover":0.73,"pressure":1010.06,"ozone":282.45},{"time":1416819600,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.0037,"precipProbability":0.09,"precipType":"rain","temperature":69.39,"apparentTemperature":69.39,"dewPoint":68.83,"humidity":0.98,"windSpeed":11.62,"windBearing":182,"visibility":10,"cloudCover":0.71,"pressure":1010.14,"ozone":281.44},{"time":1416823200,"summary":"Drizzle","icon":"rain","precipIntensity":0.0062,"precipProbability":0.24,"precipType":"rain","temperature":69.09,"apparentTemperature":69.09,"dewPoint":68.62,"humidity":0.98,"windSpeed":11.48,"windBearing":183,"visibility":10,"cloudCover":0.71,"pressure":1010.28,"ozone":280.51},{"time":1416826800,"summary":"Drizzle","icon":"rain","precipIntensity":0.009,"precipProbability":0.47,"precipType":"rain","temperature":68.96,"apparentTemperature":68.96,"dewPoint":68.54,"humidity":0.99,"windSpeed":11.17,"windBearing":185,"visibility":10,"cloudCover":0.72,"pressure":1010.52,"ozone":279.71},{"time":1416830400,"summary":"Light Rain","icon":"rain","precipIntensity":0.0104,"precipProbability":0.56,"precipType":"rain","temperature":69.25,"apparentTemperature":69.25,"dewPoint":68.49,"humidity":0.97,"windSpeed":10.91,"windBearing":189,"visibility":10,"cloudCover":0.7,"pressure":1010.87,"ozone":279.15},{"time":1416834000,"summary":"Drizzle","icon":"rain","precipIntensity":0.0089,"precipProbability":0.49,"precipType":"rain","temperature":70.14,"apparentTemperature":70.14,"dewPoint":68.36,"humidity":0.94,"windSpeed":10.96,"windBearing":199,"visibility":10,"cloudCover":0.63,"pressure":1011.45,"ozone":278.99},{"time":1416837600,"summary":"Drizzle","icon":"rain","precipIntensity":0.0062,"precipProbability":0.26,"precipType":"rain","temperature":71.42,"apparentTemperature":71.42,"dewPoint":68.16,"humidity":0.89,"windSpeed":11.51,"windBearing":212,"visibility":10,"cloudCover":0.54,"pressure":1012.15,"ozone":279.08},{"time":1416841200,"summary":"Drizzle","icon":"rain","precipIntensity":0.005,"precipProbability":0.17,"precipType":"rain","temperature":72.86,"apparentTemperature":72.86,"dewPoint":67.99,"humidity":0.85,"windSpeed":11.93,"windBearing":220,"visibility":10,"cloudCover":0.47,"pressure":1012.63,"ozone":278.95},{"time":1416844800,"summary":"Drizzle","icon":"rain","precipIntensity":0.0077,"precipProbability":0.31,"precipType":"rain","temperature":74.25,"apparentTemperature":74.25,"dewPoint":67.63,"humidity":0.8,"windSpeed":12.09,"windBearing":224,"visibility":10,"cloudCover":0.45,"pressure":1012.68,"ozone":278.38},{"time":1416848400,"summary":"Light Rain","icon":"rain","precipIntensity":0.0119,"precipProbability":0.46,"precipType":"rain","temperature":75.48,"apparentTemperature":75.48,"dewPoint":67,"humidity":0.75,"windSpeed":12.01,"windBearing":226,"visibility":10,"cloudCover":0.44,"pressure":1012.46,"ozone":277.59},{"time":1416852000,"summary":"Light Rain","icon":"rain","precipIntensity":0.0138,"precipProbability":0.48,"precipType":"rain","temperature":76.07,"apparentTemperature":76.07,"dewPoint":66.1,"humidity":0.71,"windSpeed":11.74,"windBearing":228,"visibility":10,"cloudCover":0.44,"pressure":1012.33,"ozone":276.87},{"time":1416855600,"summary":"Light Rain","icon":"rain","precipIntensity":0.0109,"precipProbability":0.38,"precipType":"rain","temperature":75.9,"apparentTemperature":75.9,"dewPoint":65.04,"humidity":0.69,"windSpeed":11.36,"windBearing":230,"visibility":10,"cloudCover":0.44,"pressure":1012.35,"ozone":276.24},{"time":1416859200,"summary":"Drizzle","icon":"rain","precipIntensity":0.0057,"precipProbability":0.13,"precipType":"rain","temperature":75.21,"apparentTemperature":75.21,"dewPoint":63.94,"humidity":0.68,"windSpeed":10.81,"windBearing":231,"visibility":10,"cloudCover":0.43,"pressure":1012.45,"ozone":275.68},{"time":1416862800,"summary":"Partly Cloudy","icon":"partly-cloudy-day","precipIntensity":0.0016,"precipProbability":0.01,"precipType":"rain","temperature":74.57,"apparentTemperature":74.57,"dewPoint":63.25,"humidity":0.68,"windSpeed":9.96,"windBearing":233,"visibility":10,"cloudCover":0.46,"pressure":1012.72,"ozone":275.38},{"time":1416866400,"summary":"Mostly Cloudy","icon":"partly-cloudy-day","precipIntensity":0,"precipProbability":0,"temperature":72.62,"apparentTemperature":72.62,"dewPoint":61.71,"humidity":0.69,"windSpeed":8.71,"windBearing":235,"visibility":10,"cloudCover":0.6,"pressure":1013.22,"ozone":275.58},{"time":1416870000,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0,"precipProbability":0,"temperature":69.82,"apparentTemperature":69.82,"dewPoint":59.67,"humidity":0.7,"windSpeed":7.22,"windBearing":237,"visibility":10,"cloudCover":0.8,"pressure":1013.88,"ozone":276.04},{"time":1416873600,"summary":"Overcast","icon":"cloudy","precipIntensity":0,"precipProbability":0,"temperature":67.68,"apparentTemperature":67.68,"dewPoint":58.34,"humidity":0.72,"windSpeed":5.92,"windBearing":243,"visibility":10,"cloudCover":0.96,"pressure":1014.56,"ozone":276.33},{"time":1416877200,"summary":"Overcast","icon":"cloudy","precipIntensity":0,"precipProbability":0,"temperature":65.88,"apparentTemperature":65.88,"dewPoint":57.59,"humidity":0.75,"windSpeed":5.12,"windBearing":251,"visibility":10,"cloudCover":1,"pressure":1015.22,"ozone":276.32},{"time":1416880800,"summary":"Overcast","icon":"cloudy","precipIntensity":0.0016,"precipProbability":0.01,"precipType":"rain","temperature":64.21,"apparentTemperature":64.21,"dewPoint":57.08,"humidity":0.78,"windSpeed":4.69,"windBearing":263,"visibility":10,"cloudCover":0.99,"pressure":1015.91,"ozone":276.13},{"time":1416884400,"summary":"Overcast","icon":"cloudy","precipIntensity":0.0019,"precipProbability":0.02,"precipType":"rain","temperature":62.62,"apparentTemperature":62.62,"dewPoint":56.1,"humidity":0.79,"windSpeed":4.74,"windBearing":278,"visibility":10,"cloudCover":0.98,"pressure":1016.55,"ozone":275.73}]},"daily":{"summary":"Light rain today through Wednesday, with temperatures peaking at 76°F on Monday.","icon":"rain","data":[{"time":1416632400,"summary":"Rain starting in the afternoon.","icon":"rain","sunriseTime":1416658226,"sunsetTime":1416695945,"moonPhase":0.01,"precipIntensity":0.0119,"precipIntensityMax":0.0444,"precipIntensityMaxTime":1416708000,"precipProbability":1,"precipType":"rain","temperatureMin":46.76,"temperatureMinTime":1416632400,"temperatureMax":65.08,"temperatureMaxTime":1416675600,"apparentTemperatureMin":44.42,"apparentTemperatureMinTime":1416632400,"apparentTemperatureMax":65.08,"apparentTemperatureMaxTime":1416675600,"dewPoint":54.12,"humidity":0.86,"windSpeed":7.47,"windBearing":60,"visibility":7.77,"cloudCover":0.72,"pressure":1024.25,"ozone":285.28},{"time":1416718800,"summary":"Rain throughout the day.","icon":"rain","sunriseTime":1416744676,"sunsetTime":1416782328,"moonPhase":0.04,"precipIntensity":0.0487,"precipIntensityMax":0.1878,"precipIntensityMaxTime":1416718800,"precipProbability":1,"precipType":"rain","temperatureMin":62.07,"temperatureMinTime":1416718800,"temperatureMax":72.26,"temperatureMaxTime":1416772800,"apparentTemperatureMin":62.07,"apparentTemperatureMinTime":1416718800,"apparentTemperatureMax":72.26,"apparentTemperatureMaxTime":1416772800,"dewPoint":66.39,"humidity":0.95,"windSpeed":10.33,"windBearing":149,"visibility":6.52,"cloudCover":0.98,"pressure":1012.89,"ozone":285.51},{"time":1416805200,"summary":"Light rain until afternoon.","icon":"rain","sunriseTime":1416831127,"sunsetTime":1416868713,"moonPhase":0.08,"precipIntensity":0.0048,"precipIntensityMax":0.0138,"precipIntensityMaxTime":1416852000,"precipProbability":0.56,"precipType":"rain","temperatureMin":61.19,"temperatureMinTime":1416888000,"temperatureMax":76.07,"temperatureMaxTime":1416852000,"apparentTemperatureMin":61.19,"apparentTemperatureMinTime":1416888000,"apparentTemperatureMax":76.07,"apparentTemperatureMaxTime":1416852000,"dewPoint":64.67,"humidity":0.84,"windSpeed":8.59,"windBearing":212,"visibility":9.93,"cloudCover":0.69,"pressure":1012.51,"ozone":278.61},{"time":1416891600,"summary":"Light rain starting in the afternoon.","icon":"rain","sunriseTime":1416917578,"sunsetTime":1416955099,"moonPhase":0.11,"precipIntensity":0.0062,"precipIntensityMax":0.0185,"precipIntensityMaxTime":1416960000,"precipProbability":0.49,"precipType":"rain","temperatureMin":48.31,"temperatureMinTime":1416974400,"temperatureMax":59.91,"temperatureMaxTime":1416891600,"apparentTemperatureMin":45.4,"apparentTemperatureMinTime":1416974400,"apparentTemperatureMax":59.91,"apparentTemperatureMaxTime":1416891600,"dewPoint":42.97,"humidity":0.67,"windSpeed":6.85,"windBearing":345,"visibility":9.8,"cloudCover":0.96,"pressure":1021.36,"ozone":270.89},{"time":1416978000,"summary":"Light rain until afternoon.","icon":"rain","sunriseTime":1417004028,"sunsetTime":1417041486,"moonPhase":0.15,"precipIntensity":0.0072,"precipIntensityMax":0.0166,"precipIntensityMaxTime":1417010400,"precipProbability":0.52,"precipType":"rain","temperatureMin":43.72,"temperatureMinTime":1417060800,"temperatureMax":58.83,"temperatureMaxTime":1417032000,"apparentTemperatureMin":41.7,"apparentTemperatureMinTime":1417060800,"apparentTemperatureMax":58.83,"apparentTemperatureMaxTime":1417032000,"dewPoint":39.07,"humidity":0.69,"windSpeed":6.37,"windBearing":340,"visibility":10,"cloudCover":0.48,"pressure":1024.52,"ozone":282.84},{"time":1417064400,"summary":"Clear throughout the day.","icon":"clear-day","sunriseTime":1417090478,"sunsetTime":1417127876,"moonPhase":0.19,"precipIntensity":0,"precipIntensityMax":0,"precipProbability":0,"temperatureMin":40.2,"temperatureMinTime":1417082400,"temperatureMax":64.39,"temperatureMaxTime":1417114800,"apparentTemperatureMin":37.36,"apparentTemperatureMinTime":1417086000,"apparentTemperatureMax":64.39,"apparentTemperatureMaxTime":1417114800,"dewPoint":38.12,"humidity":0.64,"windSpeed":4.1,"windBearing":332,"cloudCover":0,"pressure":1025.82,"ozone":281.76},{"time":1417150800,"summary":"Clear throughout the day.","icon":"clear-day","sunriseTime":1417176927,"sunsetTime":1417214267,"moonPhase":0.22,"precipIntensity":0,"precipIntensityMax":0,"precipProbability":0,"temperatureMin":41.47,"temperatureMinTime":1417168800,"temperatureMax":67.06,"temperatureMaxTime":1417204800,"apparentTemperatureMin":38.81,"apparentTemperatureMinTime":1417168800,"apparentTemperatureMax":67.06,"apparentTemperatureMaxTime":1417204800,"dewPoint":42.17,"humidity":0.69,"windSpeed":3.05,"windBearing":56,"cloudCover":0,"pressure":1025.11,"ozone":281.98},{"time":1417237200,"summary":"Clear throughout the day.","icon":"clear-day","sunriseTime":1417263376,"sunsetTime":1417300659,"moonPhase":0.26,"precipIntensity":0,"precipIntensityMax":0,"precipProbability":0,"temperatureMin":44.18,"temperatureMinTime":1417258800,"temperatureMax":70.57,"temperatureMaxTime":1417287600,"apparentTemperatureMin":42.92,"apparentTemperatureMinTime":1417258800,"apparentTemperatureMax":70.57,"apparentTemperatureMaxTime":1417287600,"dewPoint":46.38,"humidity":0.72,"windSpeed":3.09,"windBearing":64,"cloudCover":0,"pressure":1024.52,"ozone":281.89}]},"flags":{"sources":["nwspa","isd","nearest-precip","fnmoc","sref","rtma","rap","nam","cmc","gfs","madis","lamp","darksky"],"isd-stations":["720268-53882","722140-93805","749088-99999","994086-99999","999999-93805"],"madis-stations":["BFSF1","C1344","D2427","D7314","E2265","E5221","K2J9","KTLH","KTVI","MONTI","PRWF1","QUIF1","SAMF1","SHPF1","SNDF1","WAKF1"],"lamp-stations":["KTLH"],"darksky-stations":["KTLH"],"units":"us"}}';

var https = require('https'),
    moment = require('moment'),
    _ = require('underscore'),
    apiPath = '/forecast/'+process.env.API_KEY+'/',
    apiOptions = {
      host: 'api.forecast.io'
    },
    forecastCache = {};

    //Forecast cache uses the following format
    // {
    //   '-12.3456789,12.3456789': {
    //     expires: 'Sat, 23 Nov 2013 03:00:00 +0000',
    //     forecast: 'dark-sky-forecast-object'
    //   }
    // }

exports.index = function(req, res) {
  var buffer = '',
      now = moment(),
      cachedForecast = forecastCache[req.query.lat+','+req.query.lon],
      apiRequest, sendResponse, sendAPIRequest;

  //Add lat & long passed in.
  apiOptions.path = apiPath + req.query.lat+','+req.query.lon;

  //Portland 45.5118,-122.6756
  //TX 30.3264,-97.7778
  //Tallahasse
  // apiOptions.path = apiPath + '30.4398,-84.2806';

  //Send response back to browser
  sendResponse = function(data){
    res.setHeader('Content-Type', 'application/json');
    res.send(data);
  };

  //Send reques to API for a forecase
  sendAPIRequest = function(){
    //Make request to Dark Sky Weather API
    apiRequest = https.request(apiOptions, function(res){

      res.on('data', function(chunk){
        buffer += chunk;
      });

      res.on('end', function(){
        //Cache forecast for future use
        var cf = forecastCache[req.query.lat+','+req.query.lon] = {};
        cf.expires = res.headers.expires;
        cf.forecast = (process.env.MOCK === 'true') ? mock : buffer;

        sendResponse(cf.forecast);
      });
    });

    //End request
    apiRequest.end();
  };

  //If we have a cached forecast, try and use it to save an API request
  if(cachedForecast) {
    //If the cached forecast is still valid use it, else clear the cache and make a new API request
    if(now.isBefore(moment(cachedForecast.expires))) {
      sendResponse(cachedForecast.forecast);
    }
    else {
      //clear cached forecast
      delete cachedForecast;

      //Send new API request
      sendAPIRequest();
    }
  }
  else {
    sendAPIRequest();
  }
};